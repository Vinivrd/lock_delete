<script>


  //var
  let seletor = ""; //flag para diferenciar as pages 
  let selected_curso = document.querySelector(`${seletor}#selectCurso`); // curso e o displina, eu to renderizando no começo na página para ficar rápido, pois o google apps script é assincrono
  let select_Displinas = document.querySelector(`${seletor}#selectDisplinas`);
  let tot_creditos;
  let form;
  


  function showPage(pageId) {
    let elements = document.querySelectorAll('[id*="_option"]');

    elements.forEach(e => {
      //tira o select das classes
      if (e.id.includes("_selected") && !e.id.includes(pageId)) {
        e.id = e.id.slice(0, -9);
        e.classList.remove("text-blue-700");
        e.classList.add("text-gray-900");
      } else if (e.id.includes(pageId) && !e.id.includes("_selected")) {
        e.id += "_selected";
        e.classList.remove("text-gray-900");
        e.classList.add("text-blue-700");
      }
    })

    let pages = document.getElementsByClassName('content');
    for (let i = 0; i < pages.length; i++) {
      pages[i].classList.add('hidden');
    }

    let page = document.getElementById(pageId);
    page.classList.remove('hidden');

    //Trocar o seletor das páginas 
    switch (pageId) {
      case "excluir":
        seletor = "#excluir ";
        break;
      case "trancar":
        seletor = "#trancar ";
        break;

      default:
        break;
    }

    form = document.querySelector(`${seletor}#form`);

    //LISTENERS
    let sendButton = form.querySelector(`#button`)
    let errMessages = form.querySelectorAll(`#error`)
    selected_curso = form.querySelector(`#selectCurso`);
    if (selected_curso) {
      selected_curso.addEventListener('change', () => {
        atualizarDisplinas(selected_curso);
      });
    }
    if (sendButton) {
      sendButton.addEventListener('click', toggleError);
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    // Adiciona um listener para mudanças (change event) no documento
    document.addEventListener('change', function (event) {
      selected_curso = form.querySelector(`#selectCurso`);
      select_Displinas = form.querySelector(`#selectDisplinas`);
      sendButton = form.querySelector(`#button`)
      errMessages = form.querySelectorAll(`#error`)
    });
  });

  //Incializo tabel.Motivação: uma vez que o web script é assincrono.Assim, estou inicializando ele no start da página 
  //para mudar instantaneamente o select das displinas 
  const sheets = [
    "Bacharelado em Ciência de Dados", "Bacharelado em Matemática",
    "Matemática- Núcleo Geral", "Licenciatura em Matemática",
    "Bacharelado em Estatística e Ciência de Dados", "Bacharelado em Sistema de Informação",
    "Bacharelado em Ciências de Computação", "Bacharelado em Matemática Aplicada e Computação Científica"
  ];

  let table = new Array(sheets.length);
  sheets.forEach((curso, index) => {
    google.script.run.withSuccessHandler(data => {
      table[index] = data;
    }).getDisplinas(curso);
  });
  //função apra atualizar as displinas 
  function atualizarDisplinas(curso_selected) {
    select_Displinas = form.querySelector(`#selectDisplinas`);
    let value = selected_curso.value;
    let selectedOption = selected_curso.options[selected_curso.selectedIndex];
    const selectedText = selectedOption.textContent;

    while (select_Displinas.options.length > 1) {
      select_Displinas.remove(1);
    }
    updateLegend(value)
    renderDisplinas(selectedText)
  }

  //legenda do termo de aceitação
  function updateLegend(value) {
    let legendElement = form.querySelector(`#legendCurso`);
    switch (value) {
      case '0':
        legendElement.textContent = 'Eu declaro que sou aluno do curso de Bacharelado em Ciência de Dados';
        break;
      case '1':
        legendElement.textContent = 'Eu declaro que sou aluno do curso de Bacharelado em Matemática';
        break;
      case '2':
        legendElement.textContent = 'Eu declaro que sou aluno do curso de Matemática - Núcleo Geral';
        break;
      case '3':
        legendElement.textContent = 'Eu declaro que sou aluno do curso de Licenciatura em Matemática';
        break;
      case '4':
        legendElement.textContent = 'Eu declaro que sou aluno do curso de Bacharelado em Estatística e Ciência de Dados';
        break;
      case '5':
        legendElement.textContent = 'Eu declaro que sou aluno do curso de Bacharelado em Sistema de Informação';
        break;
      case '6':
        legendElement.textContent = 'Eu declaro que sou aluno do curso de Bacharelado em Ciências de Computação';
        break;
      case '7':
        legendElement.textContent = 'Eu declaro que sou aluno do curso de Bacharelado em Matemática Aplicada e Computação Científica';
        break;
      default:
        legendElement.textContent = '';
        break;
    }

  }

  function renderDisplinas(selectedText) {

    let index;
    switch (selectedText) {
      case "Bacharelado em Ciência de Dados":
        index = 0;
        break;
      case "Bacharelado em Matemática":
        index = 1;
        break;
      case "Matemática- Núcleo Geral":
        index = 2;
        break;
      case "Licenciatura em Matemática":
        index = 3;
        break;
      case "Bacharelado em Estatística e Ciência de Dados":
        index = 4;
        break;
      case "Bacharelado em Sistema de Informação":
        index = 5;
        break;
      case "Bacharelado em Ciências de Computação":
        index = 6;
        break;
      case "Bacharelado em Matemática Aplicada e Computação Científica":
        index = 7;
        break;
      default:
        break;
    }
    if (index >= 0 && index <= 7) {
      table[index].forEach((displinas, index) => {
        let optionElement = document.createElement('option');

        optionElement.value = index;
        optionElement.text = displinas[2];
        optionElement.id = displinas[2];
        optionElement.className = `select_Displinas-${index}`;
        optionElement.textContent = `${displinas[0]} ${displinas[1]}`;
        select_Displinas.appendChild(optionElement);
      })
    }
  }

  //togle submite quando nao tem o curso na lista
  function toggleNocurso() {
    let radio = form.querySelector(`#no_curso_radio`);
    let div = form.querySelector(`#curso_fora_da_lista`);

    if (radio.checked) {
      div.classList.remove("hidden");
    } else {
      div.classList.add("hidden");
    }
  }

  //calculo total de creditos
  function cal_totCreditos() {
    let prev_credit = parseInt(form.querySelector(`#tot_creditos`).value);

    if (form.querySelector("#no_curso_radio").checked) {
      let credit_nolist = parseInt(form.querySelector(`#credit_nolist`).value);
      return prev_credit - credit_nolist;
    } else {
      let index = form.querySelector(`#selectDisplinas`).value;
      let name = form.querySelector(`#selectDisplinas`).name;
      let credit_curso = parseInt(form.getElementsByClassName(`${name}-${index}`)[0].id);
      return prev_credit - credit_curso;
    }
  }



  //FUNÇõeOES PROS ERROS
  function toggleError() {
    let inputs = form.querySelectorAll(`input,select`);
    let hasError = false;


    inputs.forEach((input) => {
      const errorElement = form.querySelector(`#error-${input.name}`);
      if (input.type === 'radio') {
        if (!input.checked) {
          if (!(input.name == "no_curso")) {
            showError(errorElement, input);
            hasError = true;
          }
        } else {
          hideError(errorElement, input);
        }
      } else if (cal_totCreditos() < 12) {

        if (form.querySelector(`#no_curso_radio`).checked) {

          let error = form.querySelector(`#error-cred_discplina`);

          showError(error, form.querySelector(`#credit_nolist`));
          hasError = true;

        } else {
          let error = form.querySelector(`#error-select_Displinas`);

          showError(error, form.querySelector(`#selectDisplinas`));
          hasError = true;
          //hideError(error, document.getElementById("credit_nolist"));
        }


      } else if (!input.value) {
        let exception = ["codigo_discplina", "nome_discplina", "cred_discplina", "select_Displinas"];

        if (!exception.includes(input.name)) {
          showError(errorElement, input);
          hasError = true;
        }
      } else {
        hideError(errorElement, input);
      }
    });

    //formato valores 
    //SEND
    if (!hasError) {
      let userInfos = [];
      inputs.forEach(input => {
        //aqui eu arrumos os dados do select que está retornando o value do select 
        if (input.id.includes("select")) {
          //preciso testar se existi
          let ele  = form.getElementsByClassName(`${input.name}-${input.value}`)
          if(ele.length > 0) {
            userInfos.push(form.getElementsByClassName(`${input.name}-${input.value}`)[0].textContent);
          }else{
            userInfos.push("");
          }
          
        } else if (input.type == "radio" && input.value == 1){
          userInfos.push("Termo aceito");
        } else {
          userInfos.push(input.value);
        }

      });

      userInfos.push(cal_totCreditos());
      google.script.run.userClicked(userInfos, seletor.slice(1, -1));
      clearForm()
      alert("Dados enviados com sucesso!")
    }
  }

  function showError(errorElement, input) {
    if (errorElement) {
      errorElement.classList.remove('hidden');
    }
    input.classList.add('border-red-600');
    const label = input.previousElementSibling;
    if (label) {
      label.classList.add('text-red-600');
    }
  }
  function hideError(errorElement, input) {
    if (errorElement) {
      errorElement.classList.add('hidden');
    }
    input.classList.remove('border-red-600');
    const label = input.previousElementSibling;
    if (label) {
      label.classList.remove('text-red-600');
    }
  }

  function clearForm() {
    let inputs = form.querySelectorAll('input');
    let selects = form.querySelectorAll('select');
    let radioGroups = form.querySelectorAll('input[type="radio"]');

    // Limpar campos de input
    inputs.forEach(input => {
      if (input.type === 'radio' || input.type === 'checkbox') {
        input.checked = false;
      } else {
        input.value = '';
      }
    });

    // Limpar campos de select
    selects.forEach(select => {
      select.selectedIndex = 0;
    });

    // Limpar grupos de rádio
    radioGroups.forEach(radio => {
      radio.checked = false;
    });
  }


</script>