<script> 

  function doStuff(e) {
    //var userInfo = {};
    //userInfo.firstName = document.getElementById("fn").value;
    //google.script.run.userClicked(userInfo);
    //document.getElementById("fn").value = "";
  } 
  //Aqui eu faço o render da page
  function showPage(pageId) {
    let elements = document.querySelectorAll('[id*="_option"]');

    elements.forEach(e => {
      //tira o select
      if (e.id.includes("_selected") && !e.id.includes(pageId)) {
        e.id = e.id.slice(0, -9);
        e.classList.remove("text-blue-700");
        e.classList.add("text-gray-900");
      }else if (e.id.includes(pageId) && !e.id.includes("_selected")) {
        // Adiciona '_selected' ao ID e a classe 'text-blue-700'
        e.id += "_selected";
        e.classList.remove("text-gray-900");
        e.classList.add("text-blue-700");
      }           
    })

    let pages = document.getElementsByClassName('content');
    for (let  i = 0; i < pages.length; i++) {
      pages[i].classList.add('hidden');
    }
    
    let page = document.getElementById(pageId);
    page.classList.remove('hidden');
  }

  //Incializo tabel.Motivação: uma vez que o web script é assincrono.Assim, estou inicializando ele no start da página 
  //para mudar instantaneamente o select das displinas 
  const sheets =  [ 
    "Bacharelado em Ciência de Dados", "Bacharelado em Matemática",
    "Matemática- Núcleo Geral","Licenciatura em Matemática",
    "Bacharelado em Estatística e Ciência de Dados","Bacharelado em Sistema de Informação",
    "Bacharelado em Ciências de Computação","Bacharelado em Matemática Aplicada e Computação Científica"
  ];
  
  let table = new Array(sheets.length);
  sheets.forEach((curso, index) => {
    google.script.run.withSuccessHandler(data => {
      table[index] = data;
    }).getDisplinas(curso);
  });


  //DISPLINAS
  let selected_curso = document.getElementById("selectCurso");
  let select_Displinas = document.getElementById("selectDisplinas");
  let tot_creditos;

  selected_curso.addEventListener('change',()=> {
    let value = selected_curso.value;
    let selectedOption =  selected_curso.options[selected_curso.selectedIndex];
    const selectedText = selectedOption.textContent;

    while (select_Displinas.options.length > 1) {
        select_Displinas.remove(1);
    }
    updateLegend(value)
    renderDisplinas(selectedText)
  })

  //legenda do termo de aceitação
  function updateLegend(value) {
    let legendElement = document.getElementById('legendCurso');
    switch (value) {
      case '0':
        legendElement.textContent = 'Eu declaro que sou aluno do curso de Bacharelado em Ciência de Dados';
        break;
      case '1':
        legendElement.textContent = 'Eu declaro que sou aluno do curso de Bacharelado em Matemática';
        break;
      case '2':
        legendElement.textContent = 'Eu declaro que sou aluno do curso de Matemática - Núcleo Geral';
        break;
      case '3':
        legendElement.textContent = 'Eu declaro que sou aluno do curso de Licenciatura em Matemática';
        break;
      case '4':
        legendElement.textContent = 'Eu declaro que sou aluno do curso de Bacharelado em Estatística e Ciência de Dados';
        break;
      case '5':
        legendElement.textContent = 'Eu declaro que sou aluno do curso de Bacharelado em Sistema de Informação';
        break;
      case '6':
        legendElement.textContent = 'Eu declaro que sou aluno do curso de Bacharelado em Ciências de Computação';
        break;
      case '7':
        legendElement.textContent = 'Eu declaro que sou aluno do curso de Bacharelado em Matemática Aplicada e Computação Científica';
        break;
      default:
        legendElement.textContent = '';
        break;
    }

  }

  function renderDisplinas(selectedText){

    let index;
    switch (selectedText) {
      case "Bacharelado em Ciência de Dados":
        index = 0;
        break;
      case "Bacharelado em Matemática":
        index = 1;
        break;
      case "Matemática- Núcleo Geral":
        index = 2;
        break;
      case "Licenciatura em Matemática":
        index = 3;
        break;
      case "Bacharelado em Estatística e Ciência de Dados":
        index = 4;
        break;
      case "Bacharelado em Sistema de Informação":
        index = 5;
        break;
      case "Bacharelado em Ciências de Computação":
        index = 6;
        break;
      case "Bacharelado em Matemática Aplicada e Computação Científica":
        index = 7;
        break;
      default:
        break;
    }
    if(index >= 0 && index <=7 ){
      table[index].forEach((displinas,index) => {
        let optionElement = document.createElement('option');
   
        optionElement.value = index;
        optionElement.text = displinas[2];
        optionElement.id = displinas[2];
        optionElement.className = `${index}-option`;
        optionElement.textContent = `${displinas[0]} ${displinas[1]}`;
        select_Displinas.appendChild(optionElement);    
      })
    }
  }

  //togle submite quando nao tem o curso na lista
  
  function toggleNocurso(){
    let radio = document.getElementById("no_curso_radio");
    let div = document.getElementById("curso_fora_da_lista");

    console.log(document.getElementById("selectDisplinas"))

    if (radio.checked) {
      div.classList.remove("hidden");
    } else {
      div.classList.add("hidden");
    }
  }
  //calculo total de creditos
  function cal_totCreditos(){
    let prev_credit = parseInt(document.getElementById("tot_creditos").value);

    if(document.getElementById("no_curso_radio").checked){
      let credit_nolist = parseInt(document.getElementById("credit_nolist").value);
      return prev_credit - credit_nolist;
    }else{
      let index = document.getElementById("selectDisplinas").value;
      let credit_curso = parseInt(document.getElementsByClassName(`${index}-option`)[0].id);
      return prev_credit - credit_curso;
    }
  }

  //SEND
  document.getElementById('button').addEventListener('click', toggleError)
  const errMessages = document.querySelectorAll('#error')

  function toggleError() {
  const inputs = document.querySelectorAll('input, select');
  let hasError = false;


  inputs.forEach((input) => {
    const errorElement = document.getElementById(`error-${input.name}`);
    if (input.type === 'radio') {
      if (!input.checked) {
        if(!(input.name ==  "no_curso")){
          showError(errorElement, input);
          hasError = true;
        }
      } else {
        hideError(errorElement, input);
      }
    }else if(cal_totCreditos()< 12){ 

      if(document.getElementById("no_curso_radio").checked){

        let error = document.getElementById(`error-cred_discplina`)
  
        showError(error, document.getElementById("credit_nolist"));
        hasError = true;

      }else{ 
        let error = document.getElementById(`error-select_Displinas`);

        showError(error, document.getElementById("selectDisplinas"));
        hasError = true;
        //hideError(error, document.getElementById("credit_nolist"));
      }

      
    }else if (!input.value) {
      let exception = ["codigo_discplina","nome_discplina","cred_discplina","select_Displinas"];

      if(!exception.includes(input.name)){
        showError(errorElement, input);
        hasError = true;
      }
    } else {
      hideError(errorElement, input);
    }
  });

  

  if (!hasError) {
    cal_totCreditos();
    let userInfos = [];
    inputs.forEach(input => {
      userInfos.push(input.value);
      console.log(input.value)
    });
    console.log(cal_totCreditos())
    userInfos.push(cal_totCreditos());
    google.script.run.userClicked(userInfos);
    alert("Dados enviados com sucesso!")
  }
}

function showError(errorElement, input) {
  if (errorElement) {
    errorElement.classList.remove('hidden');
  }
  input.classList.add('border-red-600');
  const label = input.previousElementSibling;
  if (label) {
    label.classList.add('text-red-600');
  }
}

function hideError(errorElement, input) {
  if (errorElement) {
    errorElement.classList.add('hidden');
  }
  input.classList.remove('border-red-600');
  const label = input.previousElementSibling;
  if (label) {
    label.classList.remove('text-red-600');
  }
}
</script>